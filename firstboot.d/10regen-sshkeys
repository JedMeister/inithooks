#!/bin/bash -e
# generate new SSH keys; add ssh restart to 98finalize inithook
# note: ssh daemon needs to be restarted for changes to take effect

[ -n "$_TURNKEY_INIT" ] && exit 0

systemctl stop ssh.service

tmp_dir=/etc/ssh/tmp_keys
rm -rf $tmp_dir # just in case it already contains keys
mkdir -p $tmp_dir
keys="rsa ecdsa ed25519"
for key in $keys; do
   file=$tmp_dir/ssh_host_${key}_key
   echo "Generating new SSH2 ${key^^} key; this may take a while..."
   ssh-keygen -f "${file}" -N '' -t ${key}
done

mv ${tmp_dir}/*{key,key.pub} /etc/ssh/
rm -rf $tmp_dir

# ssh service restarted by 90restart_ssh
